name: "Sign Osctrl Docker images"
description: "Sign Osctrl Docker images"
inputs:
  osctrl_component:
    required: true
    description: Define the osctrl component to compile
  docker_tags:
    required: true
    description: Define the Docker tag
  docker_image_digests:
    required: true
    description: Dockerhub image digest
  docker_hub_org:
    required: true
    description: Pass DockerHub org to action
  docker_hub_username:
    required: true
    description: Pass DockerHub username to action
  docker_hub_access_token:
    required: true
    description: Pass DockerHub access token to action

runs:
  using: "composite"
  steps:
    ########################### Checkout code ###########################
    - name: Checkout code
      uses: actions/checkout@v4.1.1
      with:
        fetch-depth: 2

    ########################### Install cosign ###########################
    # https://github.com/sigstore/cosign-installer
    - name: Install cosign
      uses: sigstore/cosign-installer@main
      with:
        cosign-release: 'v2.4.1'

    ########################### Log into Dockerhub ###########################
    - name: Login to Docker Hub
      uses: docker/login-action@v3.0.0
      with:
        username: ${{ inputs.docker_hub_username }}
        password: ${{ inputs.docker_hub_access_token }}

    ########################### Sign built Docker image using keyless cosign ###########################
    - name: Sign the published Docker image
      shell: bash
      run: |
        for tag in ${{ inputs.docker_tags }}
        do
          IMAGE_NAME="${{ inputs.docker_hub_org }}/osctrl-${{ inputs.osctrl_component }}:$tag"
          for digest in ${{ inputs.docker_image_digests }}
          do
            cosign sign --yes docker.io/$IMAGE_NAME@sha256:$digest
          done
        done

    ########################### Verify signed image using keyless cosign ###########################
    - name: Verify the signed published Docker image
      shell: bash
      run: |
        for tag in ${{ inputs.docker_tags }}
        do
          IMAGE_NAME="${{ inputs.docker_hub_org }}/osctrl-${{ inputs.osctrl_component }}:$tag"
          for digest in ${{ inputs.docker_image_digests }}
          do
            cosign verify \
              --certificate-identity-regexp="https://github.com/${{ github.repository }}/.github/workflows/.*" \
              --certificate-oidc-issuer="https://token.actions.githubusercontent.com" \
              docker.io/$IMAGE_NAME@sha256:$digest
          done
        done
